<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Processor ‚Äî Paste / Read / Convert ‚Üí JSON & Quiz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
/* GI·ªÆ NGUY√äN CSS C≈® */
#pasteArea img { max-width: 100% !important; max-height: 200px !important; height: auto !important; object-fit: contain; display: block; margin: 8px auto; }
.choice strong, .choice span { display: inline; }
.choice { display: flex; align-items: center; gap: 6px; }
:root { --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0f62fe; --success:#10b981; --danger:#ef4444 }
* { box-sizing:border-box }
body { font-family:Inter,system-ui,Segoe UI,Roboto,Arial; line-height:1.45; margin:0; background:linear-gradient(180deg,var(--bg),#eef3fb); color:#0f172a }
.wrap { max-width:1100px; margin:24px auto; padding:18px }
header { display:flex; gap:12px; align-items:center; margin-bottom:12px }
h1 { font-size:18px; margin:0 }
p.lead { margin:0; color:var(--muted); font-size:13px }
.grid { display:grid; grid-template-columns:1fr 360px; gap:16px; width: 100%; display: flex; flex-direction: column; }
@media(max-width:980px) { .grid { grid-template-columns:1fr } .right-col { order:2 } }
.card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(12,20,40,0.06); width:100%; flex:1 }
label { display:block; font-weight:600; margin-bottom:6px; font-size:13px }
#pasteArea { height:300px; border:2px dashed #dbe6fb; border-radius:8px; padding:12px; overflow:auto }
#pasteArea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 4px rgba(15,98,254,0.08) }
.controls { display:flex; gap:8px; flex-wrap:wrap }
button { cursor:pointer; border:0; padding:8px 12px; border-radius:8px; background:var(--accent); color:white; font-weight:600 }
button.ghost { background:transparent; color:var(--accent); border:1px solid rgba(15,98,254,0.12) }
button.warn { background:var(--danger) }
.small { font-size:13px }
textarea#answers { width:100%; height:80px; padding:8px; border-radius:8px; border:1px solid #e6eefc }
.meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.status { font-size:13px; color:var(--muted) }
pre#jsonOut { background:#0b1220; color:#dbeafe; padding:12px; border-radius:8px; overflow:auto; max-height:260px }
.quiz-area { min-height:200px }
.question-card { padding:12px; border-radius:10px; border:1px solid #eef3fb; background:linear-gradient(180deg,#fff,#fbfdff) }
.choices { display:flex; flex-direction:column; gap:4px; margin-top:4px }
.choice { padding:10px; border-radius:8px; border:1px solid #e6eefc; cursor:pointer }
.choice.correct { outline:3px solid rgba(16,185,129,0.18); border-color:var(--success) }
.choice.wrong { outline:3px solid rgba(239,68,68,0.12); border-color:var(--danger) }
.share { display:flex; gap:8px; align-items:center }
input[type=file] { display:none }
.footer-note { font-size:13px; color:var(--muted); margin-top:8px }
#pasteArea img { max-width:100%; height:auto; border-radius:6px; display:block; margin:6px 0 }
.fullscreen-quiz .grid { grid-template-columns: 1fr !important; }
.fullscreen-quiz .grid > :not(.right-col) { display: none; }
.fullscreen-quiz .right-col { order: 1; width: 100%; }
.fullscreen-quiz .right-col .card { height: fit-content; display: flex; flex-direction: column; }
.fullscreen-quiz .quiz-area { flex: 1; overflow-y: auto; }
.right-col { display: none; }
#preview img { max-width: 100% !important; max-height: 250px !important; height: auto !important; object-fit: contain; display: block; margin: 8px auto; }
.question-card > div:first-child { align-items: flex-start; }
.question-card > div:first-child span { display: inline; }
.result-summary { padding:12px; display:flex; flex-direction:column; gap:12px; max-height: 80vh; overflow-y: auto; }
.result-stats { display:flex; gap:16px; font-size:14px; }
.result-stats .correct-count { color:#10b981; font-weight:600; }
.result-stats .wrong-count { color:#ef4444; font-weight:600; }
.result-lists { display:flex; flex-direction:column; gap:10px; }
.result-list { background:#f8f9fc; border-radius:10px; padding:10px; border:1px solid #e2e8f0; max-height:200px; overflow-y:auto; }
.result-list h4 { margin:0 0 6px 0; font-size:14px; color:#334155; }
.result-item { padding:6px 8px; margin-bottom:4px; border-radius:6px; font-size:13px; line-height:1.3; }
.result-item.correct { background:rgba(16,185,129,0.15); border-left:3px solid #10b981; }
.result-item.wrong { background:rgba(239,68,68,0.12); border-left:3px solid #ef4444; }
.result-actions { display:flex; gap:8px; margin-top:6px; }
.question-card > div { line-height: 1.5; padding: 8px 0; }
.result-item { line-height: 1.4; padding: 6px 8px; }
.question-card > div:empty { display: none; }
.result-item:empty { display: none; }
.choice.selected { background-color: rgba(15, 98, 254, 0.1); border-color: var(--accent); }
</style>
</head>
<body>
<div class="wrap">
<header>
<div>
<h1>Quiz Processor (Auto-Save)</h1>
<p class="lead">D·ªØ li·ªáu s·∫Ω t·ª± ƒë·ªông l∆∞u. N·∫øu reload trang, b·∫°n s·∫Ω ti·∫øp t·ª•c n∆°i ƒëang l√†m d·ªü.</p>
</div>
</header>
<div class="grid">
  <div>
    <div class="card">
      <label>N·ªôi dung (paste h·ªó tr·ª£ vƒÉn b·∫£n + h√¨nh ·∫£nh)</label>
      <div id="pasteArea" contenteditable="true" spellcheck="false" aria-label="Khu v·ª±c d√°n vƒÉn b·∫£n v√† h√¨nh ·∫£nh">Nh·∫≠p ho·∫∑c d√°n (Ctrl+V) n·ªôi dung v√†o ƒë√¢y.</div>
      <div style="height:10px"></div>
      <div class="meta">
        <div class="controls">
          <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:6px 10px;border-radius:8px;border:1px dashed rgba(15,98,254,0.12)">
            <input id="fileInput" type="file" accept=".doc,.docx,text/*,application/*,image/*,.html,.htm,.md,.json" />
            <span style="color:var(--accent);font-weight:700">Ch·ªçn file</span>
          </label>
          <button id="processBtn">X·ª≠ l√Ω ‚Üí JSON</button>
          <button class="ghost" id="previewJSONBtn">Xem JSON</button>
          <button id="startQuizBtn">L√†m b√†i</button>
          <button id="shareQuizBtn" class="ghost">Chia s·∫ª</button>
          <button id="clearDataBtn" class="warn small">X√≥a d·ªØ li·ªáu l∆∞u</button>
          <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
            <label><input type="checkbox" id="shuffleQuestions"> Tr·ªôn c√¢u h·ªèi</label>
            <label><input type="checkbox" id="shuffleChoices"> Tr·ªôn ƒë√°p √°n</label>
          </div>
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="autoDetectCorrect" checked/>
            <span>T·ª± nh·∫≠n di·ªán ƒë√°p √°n ƒë√∫ng (b·∫Øt ƒë·∫ßu b·∫±ng **)</span>
          </label>
        </div>
      </div>
      <div style="height:12px"></div>
      <label>Danh s√°ch ƒë√°p √°n (v√≠ d·ª•: 1a,2b,3c,...)</label>
      <textarea id="answers" placeholder="Nh·∫≠p danh s√°ch ƒë√°p √°n ·ªü d·∫°ng: 1a,2b,3c,...">1a,2a,3a,4a,5a</textarea>
      <div id="jsonSection" style="display:none; margin-top:14px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="validateBtn" class="ghost">Ki·ªÉm tra nh·∫≠n di·ªán</button>
          <button id="downloadJsonBtn">T·∫£i JSON</button>
        </div>
        <div style="height:12px"></div>
        <label>JSON (k·∫øt qu·∫£ x·ª≠ l√Ω)</label>
        <pre id="jsonOut">Ch∆∞a x·ª≠ l√Ω</pre>
      </div>
    </div>
    <div style="height:14px"></div>
    <div class="card">
      <label>Log / Th√¥ng b√°o</label>
      <div id="log" style="min-height:60px;color:var(--muted);font-size:13px">S·∫µn s√†ng.</div>
    </div>
  </div>
  <div class="right-col">
    <div class="card">
      <label>Preview / Quiz</label>
      <div id="preview" class="quiz-area">
        <div style="color:var(--muted);font-size:13px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
      </div>
      <div style="height:12px"></div>
      <div style="display:flex;justify-content:center;">
        <div class="status" id="quizStatus">0 c√¢u</div>
      </div>
      <div style="height:10px"></div>
    </div>
  </div>
</div>
</div>

<script>
const el = (s) => document.querySelector(s);
const pasteArea = el('#pasteArea');
const fileInput = el('#fileInput');
const processBtn = el('#processBtn');
const jsonOut = el('#jsonOut');
const answersInput = el('#answers');
const logEl = el('#log');
const preview = el('#preview');
const startQuizBtn = el('#startQuizBtn');
const downloadJsonBtn = el('#downloadJsonBtn');
const validateBtn = el('#validateBtn');
const previewJSONBtn = el('#previewJSONBtn');
const quizStatus = el('#quizStatus');
const shareQuizBtn = el('#shareQuizBtn');
const jsonSection = el('#jsonSection');
const clearDataBtn = el('#clearDataBtn');

let isProcessing = false;
let parsed = [];
let currentIndex = 0;
let userAnswers = {};
let autoAdvanceMs = 900;
let originalParsed = null;

// --- T√çNH NƒÇNG L∆ØU TR·∫†NG TH√ÅI (M·ªöI) ---
const STORAGE_KEY = 'quiz_pro_state';

function saveState() {
    try {
        const state = {
            parsed,
            originalParsed,
            currentIndex,
            userAnswers,
            isQuizActive: document.body.classList.contains('fullscreen-quiz'),
            timestamp: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        // console.log('ƒê√£ l∆∞u tr·∫°ng th√°i');
    } catch (e) {
        console.error('Kh√¥ng th·ªÉ l∆∞u (c√≥ th·ªÉ do ·∫£nh qu√° l·ªõn):', e);
        log('‚ö†Ô∏è C·∫£nh b√°o: File qu√° n·∫∑ng, c√≥ th·ªÉ kh√¥ng l∆∞u ƒë∆∞·ª£c ti·∫øn ƒë·ªô n·∫øu t·∫Øt tab.');
    }
}

function restoreState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const state = JSON.parse(saved);
        
        // Ch·ªâ kh√¥i ph·ª•c n·∫øu d·ªØ li·ªáu h·ª£p l·ªá
        if (state.parsed && state.parsed.length > 0) {
            parsed = state.parsed;
            originalParsed = state.originalParsed || JSON.parse(JSON.stringify(parsed));
            currentIndex = state.currentIndex || 0;
            userAnswers = state.userAnswers || {};
            
            log('‚ôªÔ∏è ƒê√£ kh√¥i ph·ª•c b√†i l√†m c≈© c·ªßa b·∫°n.');
            
            if (state.isQuizActive) {
                document.querySelector('.right-col').style.display = 'block';
                document.body.classList.add('fullscreen-quiz');
                if (currentIndex >= parsed.length) {
                    showSummary();
                } else {
                    renderQuestion(currentIndex);
                }
            } else {
                 // N·∫øu tr∆∞·ªõc ƒë√≥ ch∆∞a v√†o ch·∫ø ƒë·ªô l√†m b√†i, ch·ªâ load JSON v√†o b·ªô nh·ªõ
                 jsonOut.textContent = JSON.stringify(parsed, null, 2);
                 log('‚ôªÔ∏è ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω.');
            }
        }
    } catch (e) {
        console.error('L·ªói kh√¥i ph·ª•c:', e);
        localStorage.removeItem(STORAGE_KEY);
    }
}

function clearState() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload(); 
}

clearDataBtn.addEventListener('click', () => {
    if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u v√† l√†m m·ªõi trang?')) {
        clearState();
    }
});

// --- C√ÅC H√ÄM TI·ªÜN √çCH ---
function log(msg) { logEl.textContent = msg; }
function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

function stripHtml(html) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const allowedTags = ['P']; 
    let cleanedText = Array.from(tempDiv.childNodes)
        .filter(node => allowedTags.includes(node.nodeName) && node.nodeName !== 'O:P')
        .map(node => node.outerHTML)
        .join('')
        .replace(/<br\s*\/?>/g, '') 
        .replace(/&nbsp;/g, '')    
        .trim();
    cleanedText = cleanedText.replace(/<p[^>]*>\s*(<span[^>]*>)?&nbsp;(<\/span>)?\s*<\/p>/g, '');
    return cleanedText;
}

// --- X·ª¨ L√ù FILE ---
fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    if (f.type.startsWith('image/')) {
        const data = await fileToDataURL(f);
        pasteArea.innerHTML = `<img src="${data}" alt="file-image" />` + pasteArea.innerHTML;
        log('ƒê√£ ch√®n ·∫£nh t·ª´ file.');
        return;
    }
    if (f.name.endsWith('.docx')) {
        const reader = new FileReader();
        reader.onload = function (evt) {
            mammoth.convertToHtml({ arrayBuffer: evt.target.result })
                .then(function (result) {
                    const cleanedHtml = stripHtml(result.value);
                    pasteArea.innerHTML = cleanedHtml;
                    log('ƒê√£ ƒë·ªçc file Word: ' + f.name);
                })
                .catch((err) => log('L·ªói ƒë·ªçc Word: ' + err.message));
        };
        reader.readAsArrayBuffer(f);
        return;
    }
    const fr = new FileReader();
    fr.onload = () => {
        if (f.name.endsWith('.html') || f.type === 'text/html') {
            pasteArea.innerHTML = stripHtml(fr.result);
        } else {
            pasteArea.textContent = stripHtml(fr.result);
        }
        log('ƒê√£ ƒë·ªçc file: ' + f.name);
    };
    fr.readAsText(f);
});

pasteArea.addEventListener('paste', async (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (const it of items) {
        if (it.type.startsWith('image/')) {
            const file = it.getAsFile();
            const data = await fileToDataURL(file);
            insertHTMLAtCursor(`<img src="${data}" alt="pasted-image" />`);
            e.preventDefault();
        } else if (it.type.startsWith('text/')) {
            const text = await navigator.clipboard.readText();
            insertHTMLAtCursor(stripHtml(text));
            e.preventDefault();
        }
    }
});

function fileToDataURL(file) {
    return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
    });
}

function insertHTMLAtCursor(html) {
    const sel = window.getSelection();
    if (!sel || !sel.getRangeAt || sel.rangeCount === 0) {
        pasteArea.insertAdjacentHTML('beforeend', html);
        return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    const frag = range.createContextualFragment(html);
    range.insertNode(frag);
}

// --- X·ª¨ L√ù N·ªòI DUNG ---
function parseContent(rawHtml) {
    const cleanedHtml = rawHtml.replace(/<o:p><\/o:p>/g, '')
                               .replace(/<br\s*\/?>/g, '').replace(/<p[^>]*>\s*(<span[^>]*>)?&nbsp;(<\/span>)?\s*<\/p>/g, '');
    const container = document.createElement('div');
    container.innerHTML = cleanedHtml;
    const lines = [];
    container.childNodes.forEach((node) => {
        if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.outerHTML.trim()) lines.push(node.outerHTML.trim());
        } else if (node.nodeType === Node.TEXT_NODE) {
            const t = node.textContent.trim();
            if (t) lines.push(t);
        }
    });
    const items = [];
    let current = null;
    const choiceRegex = /^\s*(\*{1,2}\s*)?([A-Da-d])\s*[\.:]\s+/;
    const idRegex = /ID:\s*(\d+)/i;
    for (let ln of lines) {
        const cleanTxt = ln.replace(/<[^>]+>/g, '').trim();
        const idMatch = cleanTxt.match(idRegex);
        if (idMatch) {
            if (current) items.push(current);
            current = { rawId: idMatch[1], question: '', choices: [] };
            continue;
        }
        if (!current && !idMatch) current = { question: '', choices: [] };
        const choiceMatch = cleanTxt.match(choiceRegex);
        if (choiceMatch) {
            const key = choiceMatch[2].toLowerCase();
            const cleanText = cleanTxt.replace(choiceRegex, '').trim();
            const starred = /^\s*\*{1,2}/.test(cleanTxt);
            current.choices.push({ key, text: cleanText, starred });
        } else {
            const cleanLn = ln.replace(/^\s*<p>\s*\d+[\.:,)]\s*/, '<p>').replace(/^\s*\d+[\.:,)]\s*/, '');
            current.question += (current.question ? '<br>' : '') + cleanLn;
        }
    }
    if (current) items.push(current);
    return items.map((it, i) => ({
        id: i + 1,
        rawId: it.rawId || null,
        question: it.question,
        choices: it.choices,
    }));
}

function parseAnswers(txt) {
    const pairs = txt.split(/[,;\n\s]+/).map((s) => s.trim()).filter(Boolean);
    const map = [];
    for (const p of pairs) {
        const m = p.match(/(\d+)([a-d])/i);
        if (m) {
            const idx = parseInt(m[1], 10) - 1;
            if (idx >= 0) map[idx] = m[2].toLowerCase();
        }
    }
    return map;
}

processBtn.addEventListener('click', () => {
    const html = pasteArea.innerHTML;
    parsed = parseContent(html);
    parsed = parsed.map(q => ({
        ...q,
        question: q.question.replace(/<br\s*\/?>/gi, ''),
        choices: q.choices.map(choice => ({ ...choice, text: choice.text.replace(/<br\s*\/?>/gi, '') }))
    }));
    
    originalParsed = JSON.parse(JSON.stringify(parsed)); 
    const autoDetect = document.getElementById('autoDetectCorrect').checked;
    let ansMap = [];
    if (autoDetect) {
        parsed.forEach((q, i) => {
            const correctChoices = q.choices.filter(
                (c) => /^\s*\*\*/.test(c.text.trim()) || /\*\*\s*$/.test(c.text.trim()) || c.text.includes('<strong>') || c.text.includes('<b>**')
            );
            if (correctChoices.length > 0) {
                q.correct = correctChoices.map(c => c.key);
                q.multiple = correctChoices.length > 1;
                correctChoices.forEach(c => { c.text = c.text.replace(/\*\*/g, '').trim(); });
            } else {
                q.correct = [];
                q.multiple = false;
            }
        });
    } else {
        ansMap = parseAnswers(answersInput.value);
        parsed.forEach((q, i) => {
            q.correct = ansMap[i] ? [ansMap[i]] : [];
            q.multiple = false;
        });
    }
    jsonOut.textContent = JSON.stringify(parsed, null, 2);
    log('X·ª≠ l√Ω xong ‚Äî ' + parsed.length + ' c√¢u h·ªèi.');
    saveState(); // L∆ØU KHI X·ª¨ L√ù
});

startQuizBtn.addEventListener('click', () => {
    if (parsed.length === 0) processBtn.click();
    let quizData = parsed.map(q => ({
        ...q,
        choices: document.getElementById('shuffleChoices').checked ? shuffleArray([...q.choices]) : q.choices
    }));
    if (document.getElementById('shuffleQuestions').checked) quizData = shuffleArray(quizData);
    parsed = quizData;
    currentIndex = 0;
    userAnswers = {};
    originalParsed = JSON.parse(JSON.stringify(parsed));
    document.querySelector('.right-col').style.display = 'block';
    document.body.classList.add('fullscreen-quiz');
    renderQuestion(currentIndex);
    saveState(); // L∆ØU KHI B·∫ÆT ƒê·∫¶U
});

function renderQuestion(i) {
    if (!parsed[i]) {
        preview.innerHTML = '<div style="color:var(--muted)">H·∫øt c√¢u. Nh·∫•n "L√†m l·∫°i" ƒë·ªÉ l√†m l·∫°i.</div>';
        return;
    }
    const p = parsed[i];
    quizStatus.textContent = `${i + 1}/${parsed.length}`;
    const multipleNotice = p.multiple ? '<div style="color:#f59e0b; font-size:14px; margin-bottom:8px;">üìå C√¢u h·ªèi c√≥ nhi·ªÅu ƒë√°p √°n ƒë√∫ng</div>' : '';
    const choicesHtml = p.choices.map((c) => {
        // Ki·ªÉm tra xem c√¢u n√†y ƒë√£ l√†m ch∆∞a ƒë·ªÉ render l·∫°i m√†u s·∫Øc
        let classes = 'choice';
        const uAns = userAnswers[i + 'selected'] || [];
        const isSelected = uAns.includes(c.key);
        const isDone = userAnswers.hasOwnProperty(i); // ƒê√£ c√≥ k·∫øt qu·∫£ ƒë√∫ng/sai

        if (isSelected && !isDone) classes += ' selected';
        if (isDone) {
            if (p.correct.includes(c.key)) classes += ' correct';
            if (isSelected && !p.correct.includes(c.key)) classes += ' wrong';
        }
        
        return `<div class="${classes}" data-key="${c.key}">
                <strong>${c.key.toUpperCase()}.</strong> ${c.text}
            </div>`;
    }).join('');

    preview.innerHTML = `
        <div class="question-card">
            <div><strong>C√¢u ${i + 1}:</strong> ${p.question}</div>
            ${multipleNotice}
            <div class="choices">${choicesHtml}</div>
        </div>`;
    document.querySelectorAll('.choice').forEach((ch) => {
        ch.addEventListener('click', () => handleChoiceSelect(ch));
    });
}

function handleChoiceSelect(chEl) {
    if (isProcessing) return;
    // Ch·∫∑n click n·∫øu c√¢u n√†y ƒë√£ ho√†n th√†nh (ƒë√£ c√≥ k·∫øt qu·∫£ ƒë√∫ng sai)
    if (userAnswers.hasOwnProperty(currentIndex)) return; 

    isProcessing = true;
    const key = chEl.dataset.key;
    const idx = currentIndex;
    const question = parsed[idx];
    const correctAnswers = question.correct || [];
    const isMultiple = question.multiple;

    if (!userAnswers[idx + 'selected']) userAnswers[idx + 'selected'] = [];
    
    let selectedAnswers = userAnswers[idx + 'selected'];

    if (isMultiple) {
        if (selectedAnswers.includes(key)) {
            const index = selectedAnswers.indexOf(key);
            selectedAnswers.splice(index, 1);
            chEl.classList.remove('selected');
        } else {
            selectedAnswers.push(key);
            chEl.classList.add('selected');
        }
        
        // Logic ki·ªÉm tra nhi·ªÅu ƒë√°p √°n: Ch·ªâ x·ª≠ l√Ω khi user ch·ªçn ƒë·ªß s·ªë l∆∞·ª£ng ƒë√°p √°n ƒë√∫ng
        if (selectedAnswers.length === correctAnswers.length) {
             const allCorrectSelected = correctAnswers.every(ca => selectedAnswers.includes(ca));
             // Hi·ªÉn th·ªã k·∫øt qu·∫£
             document.querySelectorAll('.choice').forEach((c) => {
                 const choiceKey = c.dataset.key;
                 if (correctAnswers.includes(choiceKey)) c.classList.add('correct');
                 if (selectedAnswers.includes(choiceKey) && !correctAnswers.includes(choiceKey)) c.classList.add('wrong');
             });
             userAnswers[idx] = allCorrectSelected;
             saveState(); // L∆ØU SAU KHI L√ÄM XONG 1 C√ÇU
             
             setTimeout(() => {
                isProcessing = false;
                currentIndex++;
                if (currentIndex < parsed.length) {
                    renderQuestion(currentIndex);
                    saveState(); // L∆ØU V·ªä TR√ç M·ªöI
                } else {
                    showSummary();
                    saveState();
                }
            }, autoAdvanceMs);
        } else {
            isProcessing = false;
            saveState(); // L∆ØU TR·∫†NG TH√ÅI ƒêANG CH·ªåN D·ªû
        }
    } else {
        // C√¢u h·ªèi 1 ƒë√°p √°n
        userAnswers[idx + 'selected'] = [key];
        document.querySelectorAll('.choice').forEach((c) => c.classList.remove('correct', 'wrong', 'selected'));
        
        if (correctAnswers.includes(key)) {
            chEl.classList.add('correct');
            userAnswers[idx] = true;
        } else {
            chEl.classList.add('wrong');
            userAnswers[idx] = false;
            correctAnswers.forEach(correctKey => {
                const correctEl = Array.from(document.querySelectorAll('.choice')).find((c) => c.dataset.key === correctKey);
                if (correctEl) correctEl.classList.add('correct');
            });
        }
        saveState(); // L∆ØU K·∫æT QU·∫¢

        setTimeout(() => {
            isProcessing = false;
            currentIndex++;
            if (currentIndex < parsed.length) {
                 renderQuestion(currentIndex);
                 saveState(); // L∆ØU V·ªä TR√ç M·ªöI
            } else {
                 showSummary();
                 saveState();
            }
        }, autoAdvanceMs);
    }
}

function showSummary() {
    const total = parsed.length;
    const correctList = [];
    const wrongList = [];
    const wrongIndexes = [];
    parsed.forEach((q, i) => {
        const isCorrect = userAnswers[i];
        const questionHtml = q.question.replace(/<br\s*\/?>/gi, '<br>');
        const userSelected = userAnswers[i + 'selected'] || [];
        const correctAnswers = q.correct || [];
        if (isCorrect) {
            correctList.push(`<div class="result-item correct"><strong>C√¢u ${i + 1}:</strong> ${questionHtml}</div>`);
        } else {
            wrongIndexes.push(i);
            const userKeys = Array.isArray(userSelected) ? userSelected.join(', ').toUpperCase() : userSelected;
            const correctKeys = correctAnswers.join(', ').toUpperCase();
            const allChoices = q.choices.map(c => `<div>${c.key.toUpperCase()}. ${c.text}</div>`).join('');
            wrongList.push(`
                <div class="result-item wrong">
                    <strong>C√¢u ${i + 1}:</strong> ${questionHtml}<br>
                    <b>Ch·ªçn:</b> ${userKeys}<br>
                    <b>ƒê√∫ng:</b> ${correctKeys}<br>
                    <div style="margin-left:12px"><u>C√°c ƒë√°p √°n:</u><br>${allChoices}</div>
                </div>`);
        }
    });
    const btnRetryWrong = wrongIndexes.length > 0 ? `<button id="retryWrongBtn" class="warn">L√†m l·∫°i c√¢u sai</button>` : '';
    preview.innerHTML = `
    <div class="result-summary">
        <h3>K·∫øt qu·∫£ l√†m b√†i</h3>
        <div class="result-stats">
            <span class="correct-count">ƒê√∫ng: ${correctList.length}</span>
            <span class="wrong-count">Sai: ${wrongList.length}</span>
            <span>T·ªïng: ${total}</span>
        </div>
        <div class="result-lists">
            <div class="result-list"><h4>‚úÖ C√¢u ƒë√∫ng (${correctList.length})</h4>${correctList.join('')}</div>
            <div class="result-list"><h4>‚ùå C√¢u sai (${wrongList.length})</h4>${wrongList.join('')}</div>
        </div>
        <div class="result-actions">
            <button id="retryBtn">L√†m l·∫°i t·∫•t c·∫£</button>
            ${btnRetryWrong}
            <button id="exitBtn" class="ghost">Quay l·∫°i trang ch·ªß</button>
        </div>
    </div>`;
    
    document.getElementById('retryBtn').addEventListener('click', () => {
        parsed = JSON.parse(JSON.stringify(originalParsed));
        currentIndex = 0;
        userAnswers = {};
        renderQuestion(0);
        saveState();
    });
    
    if (wrongIndexes.length > 0) {
        document.getElementById('retryWrongBtn').addEventListener('click', () => {
            let fullQuiz = originalParsed || parsed;
            parsed = wrongIndexes.map(idx => JSON.parse(JSON.stringify(fullQuiz[idx])));
            currentIndex = 0;
            userAnswers = {};
            renderQuestion(0);
            saveState();
        });
    }
    document.getElementById('exitBtn').addEventListener('click', () => {
        document.body.classList.remove('fullscreen-quiz');
        document.querySelector('.right-col').style.display = 'none';
        preview.innerHTML = `<div style="color:var(--muted);font-size:13px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;
        parsed = originalParsed ? JSON.parse(JSON.stringify(originalParsed)) : parsed;
        // Khi exit th√¨ x√≥a tr·∫°ng th√°i l√†m d·ªü, nh∆∞ng gi·ªØ l·∫°i JSON ƒë√£ parse
        const state = { parsed, originalParsed, currentIndex:0, userAnswers:{}, isQuizActive: false };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    });
}

previewJSONBtn.addEventListener('click', () => {
    jsonSection.style.display = jsonSection.style.display === 'none' ? 'block' : 'none';
});
validateBtn.addEventListener('click', () => {
    if (parsed.length === 0) return alert('Ch∆∞a x·ª≠ l√Ω n·ªôi dung!');
    const ansMap = parseAnswers(answersInput.value);
    const issues = [];
    parsed.forEach((p, i) => {
        if (!p.question || p.question.length < 5) issues.push(`C√¢u ${i + 1}: c√¢u h·ªèi ng·∫Øn`);
        if (p.choices && p.choices.length > 0) {
            const keys = p.choices.map((c) => c.key);
            if (ansMap[i] && !keys.includes(ansMap[i])) issues.push(`C√¢u ${i + 1}: ƒë√°p √°n ${ansMap[i]} kh√¥ng c√≥ trong l·ª±a ch·ªçn`);
        }
    });
    log(issues.length === 0 ? 'Kh√¥ng ph√°t hi·ªán l·ªói l·ªõn.' : issues.join('\n'));
});
downloadJsonBtn.addEventListener('click', () => {
    if (jsonOut.textContent.trim() === '') return alert('Ch∆∞a c√≥ JSON');
    const blob = new Blob([jsonOut.textContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'quiz.json';
    a.click();
    URL.revokeObjectURL(url);
});
shareQuizBtn.addEventListener('click', () => {
    if (parsed.length === 0) { alert('Ch∆∞a c√≥ quiz ƒë·ªÉ chia s·∫ª!'); return; }
    const json = JSON.stringify(parsed);
    const encoded = btoa(unescape(encodeURIComponent(json)));
    const link = `${location.origin}${location.pathname}?d=${encoded}`;
    navigator.clipboard.writeText(link).then(() => log('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!')).catch(err => log('‚ùå L·ªói copy link: ' + err));
});

// KH·ªûI ƒê·ªòNG: KI·ªÇM TRA LINK CHIA S·∫∫ HO·∫∂C RESTORE D·ªÆ LI·ªÜU C≈®
window.addEventListener('load', () => {
    const params = new URLSearchParams(location.search);
    const encoded = params.get('d');
    if (encoded) {
        try {
            const decoded = decodeURIComponent(escape(atob(encoded)));
            parsed = JSON.parse(decoded);
            document.querySelector('.right-col').style.display = 'block';
            document.body.classList.add('fullscreen-quiz');
            currentIndex = 0;
            userAnswers = {};
            originalParsed = JSON.parse(JSON.stringify(parsed));
            renderQuestion(currentIndex);
            log('üì¶ ƒê√£ t·∫£i quiz t·ª´ link chia s·∫ª.');
        } catch (e) { console.error('‚ùå L·ªói gi·∫£i m√£ quiz', e); }
    } else {
        // KH√îNG C√ì LINK CHIA S·∫∫ => TH·ª¨ RESTORE D·ªÆ LI·ªÜU C≈®
        restoreState();
    }
});
</script>
</body>
</html>
