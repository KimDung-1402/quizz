
<!doctype html>

<html lang="vi">

<head>

<meta charset="utf-8" />

<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Quiz Processor ‚Äî Paste / Read / Convert ‚Üí JSON & Quiz</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<style>

#pasteArea img {

max-width: 100% !important;

max-height: 250px !important; /* ch·ªânh chi·ªÅu cao theo √Ω b·∫°n */

height: auto !important;

object-fit: contain;

display: block;

margin: 8px auto;

}

.choice strong,

.choice span {

display: inline;

}

.choice {

display: flex;

align-items: center;

gap: 6px;

}

:root { --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0f62fe; --success:#10b981; --danger:#ef4444 }

* { box-sizing:border-box }

body { font-family:Inter,system-ui,Segoe UI,Roboto,Arial; line-height:1.45; margin:0; background:linear-gradient(180deg,var(--bg),#eef3fb); color:#0f172a }

.wrap { max-width:1100px; margin:24px auto; padding:18px }

header { display:flex; gap:12px; align-items:center; margin-bottom:12px }

h1 { font-size:18px; margin:0 }

p.lead { margin:0; color:var(--muted); font-size:13px }

.grid { display:grid; grid-template-columns:1fr 360px; gap:16px; width: 100%; display: flex; flex-direction: column; }

@media(max-width:980px) { .grid { grid-template-columns:1fr } .right-col { order:2 } }

.card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(12,20,40,0.06); width:100%; flex:1 }

label { display:block; font-weight:600; margin-bottom:6px; font-size:13px }

#pasteArea { height:300px; border:2px dashed #dbe6fb; border-radius:8px; padding:12px; overflow:auto }

#pasteArea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 4px rgba(15,98,254,0.08) }

.controls { display:flex; gap:8px; flex-wrap:wrap }

button { cursor:pointer; border:0; padding:8px 12px; border-radius:8px; background:var(--accent); color:white; font-weight:600 }

button.ghost { background:transparent; color:var(--accent); border:1px solid rgba(15,98,254,0.12) }

button.warn { background:var(--danger) }

.small { font-size:13px }

textarea#answers { width:100%; height:80px; padding:8px; border-radius:8px; border:1px solid #e6eefc }

.meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap }

.status { font-size:13px; color:var(--muted) }

pre#jsonOut { background:#0b1220; color:#dbeafe; padding:12px; border-radius:8px; overflow:auto; max-height:260px }

.quiz-area { min-height:200px }

.question-card { padding:12px; border-radius:10px; border:1px solid #eef3fb; background:linear-gradient(180deg,#fff,#fbfdff) }

.choices { display:flex; flex-direction:column; gap:4px; margin-top:4px }

.choice { padding:10px; border-radius:8px; border:1px solid #e6eefc; cursor:pointer }

.choice.correct { outline:3px solid rgba(16,185,129,0.18); border-color:var(--success) }

.choice.wrong { outline:3px solid rgba(239,68,68,0.12); border-color:var(--danger) }

.share { display:flex; gap:8px; align-items:center }

input[type=file] { display:none }

.footer-note { font-size:13px; color:var(--muted); margin-top:8px }

#pasteArea img { max-width:100%; height:auto; border-radius:6px; display:block; margin:6px 0 }

.fullscreen-quiz .grid {

grid-template-columns: 1fr !important;

}

.fullscreen-quiz .grid > :not(.right-col) {

display: none;

}

.fullscreen-quiz .right-col {

order: 1;

width: 100%;

}

.fullscreen-quiz .right-col .card {

height: fit-content;

display: flex;

flex-direction: column;

}

.fullscreen-quiz .quiz-area {

flex: 1;

overflow-y: auto;

}

.right-col {

display: none;

}

#preview img {

max-width: 100% !important;

max-height: 250px !important; /* ho·∫∑c chi·ªÅu cao b·∫°n mu·ªën */

height: auto !important;

object-fit: contain;

display: block;

margin: 8px auto;

}

.question-card > div:first-child {

align-items: flex-start;

}

.question-card > div:first-child span {

display: inline; /* ƒë·∫£m b·∫£o hi·ªÉn th·ªã c·∫°nh s·ªë th·ª© t·ª± */

}

.result-summary {

padding:12px;

display:flex;

flex-direction:column;

gap:12px;

max-height: 80vh;

overflow-y: auto;

}

.result-stats {

display:flex;

gap:16px;

font-size:14px;

}

.result-stats .correct-count { color:#10b981; font-weight:600; }

.result-stats .wrong-count { color:#ef4444; font-weight:600; }

.result-lists {

display:flex;

flex-direction:column;

gap:10px;

}

.result-list {

background:#f8f9fc;

border-radius:10px;

padding:10px;

border:1px solid #e2e8f0;

max-height:200px;

overflow-y:auto;

}

.result-list h4 {

margin:0 0 6px 0;

font-size:14px;

color:#334155;

}

.result-item {

padding:6px 8px;

margin-bottom:4px;

border-radius:6px;

font-size:13px;

line-height:1.3;

}

.result-item.correct {

background:rgba(16,185,129,0.15);

border-left:3px solid #10b981;

}

.result-item.wrong {

background:rgba(239,68,68,0.12);

border-left:3px solid #ef4444;

}

.result-actions {

display:flex;

gap:8px;

margin-top:6px;

}

</style>

</head>

<body>

<div class="wrap">

<header>

<div>

<h1>Quiz Processor</h1>

<p class="lead">D√°n (Ctrl+V) ho·∫∑c ch·ªçn file ƒë·ªÉ nh·∫≠p n·ªôi dung c√≥ th·ªÉ k√®m h√¨nh ·∫£nh. X·ª≠ l√Ω th√†nh JSON v√† chuy·ªÉn sang ch·∫ø ƒë·ªô l√†m b√†i (quiz).</p>

</div>

</header>

<div class="grid">
  <div>
    <div class="card">
      <label>N·ªôi dung (paste h·ªó tr·ª£ vƒÉn b·∫£n + h√¨nh ·∫£nh)</label>
      <div id="pasteArea" contenteditable="true" spellcheck="false" aria-label="Khu v·ª±c d√°n vƒÉn b·∫£n v√† h√¨nh ·∫£nh">Nh·∫≠p ho·∫∑c d√°n (Ctrl+V) n·ªôi dung v√†o ƒë√¢y. H·ªó tr·ª£ paste h√¨nh ·∫£nh t·ª´ clipboard (Ctrl+V h√¨nh).</div>
      <div style="height:10px"></div>

      <div class="meta">
        <div class="controls">
          <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:6px 10px;border-radius:8px;border:1px dashed rgba(15,98,254,0.12)">
            <input id="fileInput" type="file" accept=".doc,.docx,text/*,application/*,image/*,.html,.htm,.md,.json" />
            <span style="color:var(--accent);font-weight:700">Ch·ªçn file</span>
          </label>
          <button id="processBtn">X·ª≠ l√Ω ‚Üí JSON</button>
          <button class="ghost" id="previewJSONBtn">Xem JSON</button>
          <button id="startQuizBtn">L√†m b√†i</button>
          <button id="shareQuizBtn" class="ghost">Chia s·∫ª</button>
          <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
            <label><input type="checkbox" id="shuffleQuestions"> Tr·ªôn c√¢u h·ªèi</label>
            <label><input type="checkbox" id="shuffleChoices"> Tr·ªôn ƒë√°p √°n</label>
          </div>
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="autoDetectCorrect" checked/>
            <span>T·ª± nh·∫≠n di·ªán ƒë√°p √°n ƒë√∫ng (b·∫Øt ƒë·∫ßu b·∫±ng **)</span>
          </label>
        </div>
      </div>

      <div style="height:12px"></div>

      <label>Danh s√°ch ƒë√°p √°n (v√≠ d·ª•: 1a,2b,3c,...)</label>
      <textarea id="answers" placeholder="Nh·∫≠p danh s√°ch ƒë√°p √°n ·ªü d·∫°ng: 1a,2b,3c,...">1a,2a,3a,4a,5a</textarea>

      <!-- PH·∫¶N JSON b·ªã ·∫©n m·∫∑c ƒë·ªãnh -->
      <div id="jsonSection" style="display:none; margin-top:14px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="validateBtn" class="ghost">Ki·ªÉm tra nh·∫≠n di·ªán</button>
          <button id="downloadJsonBtn">T·∫£i JSON</button>
        </div>
        <div style="height:12px"></div>
        <label>JSON (k·∫øt qu·∫£ x·ª≠ l√Ω)</label>
        <pre id="jsonOut">Ch∆∞a x·ª≠ l√Ω</pre>
        <div class="footer-note">G·ª£i √Ω: n·∫øu paste t·ª´ Word/HTML, script c·ªë g·∫Øng t√°ch c√¢u theo c√°c block b·∫Øt ƒë·∫ßu b·∫±ng <code>ID:</code> ho·∫∑c s·ªë th·ª© t·ª±. B·∫°n c√≥ th·ªÉ ch·ªânh tay n·∫øu c·∫ßn.</div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <label>Log / Th√¥ng b√°o</label>
      <div id="log" style="min-height:60px;color:var(--muted);font-size:13px">S·∫µn s√†ng.</div>
    </div>
  </div>

  <div class="right-col">
    <div class="card">
      <label>Preview / Quiz</label>
      <div id="preview" class="quiz-area">
        <div style="color:var(--muted);font-size:13px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
      </div>

      <div style="height:12px"></div>
      <div style="display:flex;justify-content:center;">
        <div class="status" id="quizStatus">0 c√¢u</div>
      </div>

      <div style="height:10px"></div>
    </div>
  </div>
</div>
</div>

<script>

const el = (s) => document.querySelector(s);

const pasteArea = el('#pasteArea');

const fileInput = el('#fileInput');

const processBtn = el('#processBtn');

const jsonOut = el('#jsonOut');

const answersInput = el('#answers');

const logEl = el('#log');

const preview = el('#preview');

const startQuizBtn = el('#startQuizBtn');

const downloadJsonBtn = el('#downloadJsonBtn');

const validateBtn = el('#validateBtn');

const previewJSONBtn = el('#previewJSONBtn');

const quizStatus = el('#quizStatus');

const shareQuizBtn = el('#shareQuizBtn');

const jsonSection = el('#jsonSection');

let isProcessing = false;

let parsed = [];

let currentIndex = 0;

let userAnswers = {};

let autoAdvanceMs = 900;

function log(msg) { logEl.textContent = msg; }

function shuffleArray(arr) {

for (let i = arr.length - 1; i > 0; i--) {

const j = Math.floor(Math.random() * (i + 1));

[arr[i], arr[j]] = [arr[j], arr[i]];

}

return arr;

}

function stripHtml(html) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // Ch·ªâ gi·ªØ l·∫°i th·∫ª <br> v√† <p>, lo·∫°i b·ªè c√°c th·∫ª kh√°c
    const allowedTags = ['BR', 'P'];
    const cleanedText = Array.from(tempDiv.childNodes)
        .filter(node => allowedTags.includes(node.nodeName))
        .map(node => node.outerHTML).join('');
    
    return cleanedText.replace(/<p>/g, '<p>').replace(/<\/p>/g, '<br>'); // Thay ƒë·ªïi th·∫ª <p> th√†nh <br>
}

// ‚úÖ H√ÄM CHIA S·∫∫ M·ªöI

shareQuizBtn.addEventListener('click', () => {

if (parsed.length === 0) { alert('Ch∆∞a c√≥ quiz ƒë·ªÉ chia s·∫ª!'); return; }

const json = JSON.stringify(parsed);

const encoded = btoa(unescape(encodeURIComponent(json)));

const link = `${location.origin}${location.pathname}?d=${encoded}`;

navigator.clipboard.writeText(link)

.then(() => log('‚úÖ ƒê√£ sao ch√©p link chia s·∫ª!'))

.catch(err => log('‚ùå L·ªói copy link: ' + err));

});

// ‚úÖ KHI NG∆Ø·ªúI KH√ÅC M·ªû LINK

window.addEventListener('load', () => {

const params = new URLSearchParams(location.search);

const encoded = params.get('d');

if (encoded) {

try {

const decoded = decodeURIComponent(escape(atob(encoded)));

parsed = JSON.parse(decoded);

document.querySelector('.right-col').style.display = 'block';

document.body.classList.add('fullscreen-quiz');

currentIndex = 0;

userAnswers = {};

renderQuestion(currentIndex);

log('üì¶ ƒê√£ t·∫£i quiz t·ª´ link chia s·∫ª.');

} catch (e) {

console.error('‚ùå L·ªói gi·∫£i m√£ quiz', e);

}

}

});
fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];

    if (!f) return;

    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p l√† h√¨nh ·∫£nh
    if (f.type.startsWith('image/')) {
        const data = await fileToDataURL(f);
        pasteArea.innerHTML = `<img src="${data}" alt="file-image" />` + pasteArea.innerHTML;
        log('ƒê√£ ch√®n ·∫£nh t·ª´ file.');
        return;
    }

    // X·ª≠ l√Ω file Word
    if (f.name.endsWith('.docx')) {
        const reader = new FileReader();
        reader.onload = function (evt) {
            mammoth.convertToHtml({ arrayBuffer: evt.target.result })
                .then(function (result) {
                    // L√†m s·∫°ch HTML
                    const cleanedHtml = stripHtml(result.value); // S·ª≠ d·ª•ng h√†m stripHtml ƒë·ªÉ lo·∫°i b·ªè th·∫ª kh√¥ng c·∫ßn thi·∫øt
                    pasteArea.innerHTML = cleanedHtml;
                    log('ƒê√£ ƒë·ªçc file Word: ' + f.name);
                })
                .catch((err) => log('L·ªói ƒë·ªçc Word: ' + err.message));
        };
        reader.readAsArrayBuffer(f);
        return;
    }

    // X·ª≠ l√Ω file vƒÉn b·∫£n v√† HTML
    const fr = new FileReader();
    fr.onload = () => {
        if (f.name.endsWith('.html') || f.type === 'text/html') {
            // L√†m s·∫°ch HTML
            const cleanedHtml = stripHtml(fr.result); // S·ª≠ d·ª•ng h√†m stripHtml ƒë·ªÉ lo·∫°i b·ªè th·∫ª kh√¥ng c·∫ßn thi·∫øt
            pasteArea.innerHTML = cleanedHtml;
        } else {
            // Gi·ªØ nguy√™n vƒÉn b·∫£n
            const cleanedText = stripHtml(fr.result); // L√†m s·∫°ch vƒÉn b·∫£n
            pasteArea.textContent = cleanedText;
        }
        log('ƒê√£ ƒë·ªçc file: ' + f.name);
    };
    fr.readAsText(f);
});

// H√†m lo·∫°i b·ªè th·∫ª HTML kh√¥ng c·∫ßn thi·∫øt v√† k√Ω t·ª± &nbsp;
function stripHtml(html) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // Ch·ªâ gi·ªØ l·∫°i th·∫ª <br> v√† <p>, lo·∫°i b·ªè c√°c th·∫ª kh√°c
    const allowedTags = ['BR', 'P'];
    const cleanedText = Array.from(tempDiv.childNodes)
        .filter(node => allowedTags.includes(node.nodeName))
        .map(node => node.outerHTML).join('');

    // Lo·∫°i b·ªè k√Ω t·ª± &nbsp;
    return cleanedText.replace(/&nbsp;/g, '').replace(/<p>/g, '<p>').replace(/<\/p>/g, '<br>'); // Gi·ªØ th·∫ª <p> v√† thay th·∫ø b·∫±ng <br>
}

// Utility

function log(msg) {

logEl.textContent = msg;

}

function shuffleArray(arr) {

for (let i = arr.length - 1; i > 0; i--) {

const j = Math.floor(Math.random() * (i + 1));

[arr[i], arr[j]] = [arr[j], arr[i]];

}

return arr;

}

shareQuizBtn.addEventListener('click', () => {

if (parsed.length === 0) { alert('Ch∆∞a c√≥ quiz ƒë·ªÉ chia s·∫ª!'); return; }

const data = encodeURIComponent(JSON.stringify(parsed));

const link = window.location.origin + window.location.pathname + '?quiz=' + data;

navigator.clipboard.writeText(link)

.then(() => log('Li√™n k·∫øt quiz ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!'))

.catch(err => log('L·ªói copy link: ' + err));

});

// Paste handling

pasteArea.addEventListener('paste', async (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;

    for (const it of items) {
        if (it.type.startsWith('image/')) {
            const file = it.getAsFile();
            const data = await fileToDataURL(file);
            insertHTMLAtCursor(`<img src="${data}" alt="pasted-image" />`);
            e.preventDefault();
        } else if (it.type.startsWith('text/')) {
            const text = await navigator.clipboard.readText();
            const cleanText = stripHtml(text); // L√†m s·∫°ch HTML
            insertHTMLAtCursor(cleanText);
            e.preventDefault();
        }
    }
});

function fileToDataURL(file) {

return new Promise((res, rej) => {

const fr = new FileReader();

fr.onload = () => res(fr.result);

fr.onerror = rej;

fr.readAsDataURL(file);

});

}

function insertHTMLAtCursor(html) {

const sel = window.getSelection();

if (!sel || !sel.getRangeAt || sel.rangeCount === 0) {

pasteArea.insertAdjacentHTML('beforeend', html);

return;

}

const range = sel.getRangeAt(0);

range.deleteContents();

const frag = range.createContextualFragment(html);

range.insertNode(frag);

}

// File input



// Parse content

function parseContent(rawHtml) {
    const container = document.createElement('div');
    container.innerHTML = rawHtml || '';
    const lines = [];
    container.childNodes.forEach((node) => {
        if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.outerHTML.trim()) lines.push(node.outerHTML.trim());
        } else if (node.nodeType === Node.TEXT_NODE) {
            const t = node.textContent.trim();
            if (t) lines.push(t);
        }
    });

    const items = [];
    let current = null;
    const choiceRegex = /^\**\s*([A-D])\.?\s*/i;
    const idRegex = /ID:\s*(\d+)/i;

    for (let ln of lines) {
        const cleanTxt = ln.replace(/<[^>]+>/g, '').trim();
        const idMatch = cleanTxt.match(idRegex);

        if (idMatch) {
            if (current) items.push(current);
            current = { rawId: idMatch[1], question: '', choices: [] };
            continue;
        }

        if (!current && !idMatch) current = { question: '', choices: [] };

        const choiceMatch = cleanTxt.match(choiceRegex);
        if (choiceMatch) {
            const key = choiceMatch[1].toLowerCase();
            const cleanText = cleanTxt.replace(choiceRegex, '').trim();
            current.choices.push({ key, text: cleanText });
        } else {
            const cleanLn = ln.replace(/^\s*<p>\s*\d+[\.:,)]\s*/, '<p>').replace(/^\s*\d+[\.:,)]\s*/, '');
            current.question += (current.question ? '<br>' : '') + cleanLn;
        }
    }

    if (current) items.push(current);
    return items.map((it, i) => ({
        id: i + 1,
        rawId: it.rawId || null,
        question: it.question,
        choices: it.choices,
    }));
}


// Parse answers

function parseAnswers(txt) {

const pairs = txt.split(/[,;\n\s]+/).map((s) => s.trim()).filter(Boolean);

const map = [];

for (const p of pairs) {

const m = p.match(/(\d+)([a-d])/i);

if (m) {

const idx = parseInt(m[1], 10) - 1;

if (idx >= 0) map[idx] = m[2].toLowerCase();

}

}

return map;

}

// Process button

processBtn.addEventListener('click', () => {
    const html = pasteArea.innerHTML;
    parsed = parseContent(html);
    const autoDetect = document.getElementById('autoDetectCorrect').checked;
    let ansMap = [];

    if (autoDetect) {
        parsed.forEach((q, i) => {
            // T√¨m t·∫•t c·∫£ c√°c ƒë√°p √°n c√≥ ƒë√°nh d·∫•u **
            const correctChoices = q.choices.filter(
                (c) => /^\s*\*\*/.test(c.text.trim()) || /\*\*\s*$/.test(c.text.trim()) ||
                        c.text.includes('<strong>') || c.text.includes('<b>**')
            );

            if (correctChoices.length > 0) {
                // N·∫øu c√≥ nhi·ªÅu ƒë√°p √°n ƒë√∫ng
                q.correct = correctChoices.map(c => c.key);
                q.multiple = correctChoices.length > 1; // ƒê√°nh d·∫•u l√† c√¢u h·ªèi nhi·ªÅu ƒë√°p √°n
                
                // X√≥a d·∫•u ** kh·ªèi text
                correctChoices.forEach(c => {
                    c.text = c.text.replace(/\*\*/g, '').trim();
                });
            } else {
                q.correct = [];
                q.multiple = false;
            }
        });
    } else {
        ansMap = parseAnswers(answersInput.value);
        parsed.forEach((q, i) => {
            q.correct = ansMap[i] ? [ansMap[i]] : [];
            q.multiple = false;
        });
    }

    jsonOut.textContent = JSON.stringify(parsed, null, 2);
    log('X·ª≠ l√Ω xong ‚Äî ' + parsed.length + ' c√¢u h·ªèi.');
});



// Toggle JSON preview

previewJSONBtn.addEventListener('click', () => {

jsonSection.style.display =

jsonSection.style.display === 'none' ? 'block' : 'none';

});

// Validate

validateBtn.addEventListener('click', () => {

if (parsed.length === 0) return alert('Ch∆∞a x·ª≠ l√Ω n·ªôi dung!');

const ansMap = parseAnswers(answersInput.value);

const issues = [];

parsed.forEach((p, i) => {

if (!p.question || p.question.length < 5) issues.push(`C√¢u ${i + 1}: c√¢u h·ªèi ng·∫Øn`);

if (p.choices && p.choices.length > 0) {

const keys = p.choices.map((c) => c.key);

if (ansMap[i] && !keys.includes(ansMap[i]))

issues.push(`C√¢u ${i + 1}: ƒë√°p √°n ${ansMap[i]} kh√¥ng c√≥ trong l·ª±a ch·ªçn`);

}

});

log(issues.length === 0 ? 'Kh√¥ng ph√°t hi·ªán l·ªói l·ªõn.' : issues.join('\n'));

});

// Download JSON

downloadJsonBtn.addEventListener('click', () => {

if (jsonOut.textContent.trim() === '') return alert('Ch∆∞a c√≥ JSON');

const blob = new Blob([jsonOut.textContent], { type: 'application/json' });

const url = URL.createObjectURL(blob);

const a = document.createElement('a');

a.href = url;

a.download = 'quiz.json';

a.click();

URL.revokeObjectURL(url);

});

// Start quiz

startQuizBtn.addEventListener('click', () => {

// X·ª≠ l√Ω n·∫°p c√¢u h·ªèi n·∫øu ch∆∞a c√≥

if (parsed.length === 0) processBtn.click();

const shuffleQs = document.getElementById('shuffleQuestions').checked;

const shuffleCs = document.getElementById('shuffleChoices').checked;

// T·∫°o b·∫£n sao c√¢u h·ªèi ƒë·ªÉ c√≥ th·ªÉ tr·ªôn

let quizData = parsed.map(q => ({

...q,

choices: shuffleCs ? shuffleArray([...q.choices]) : q.choices

}));

// N·∫øu ch·ªçn tr·ªôn c√¢u h·ªèi th√¨ d√πng shuffleArray (Fisher-Yates) ƒë·ªÉ tr·ªôn m·∫£ng

if (shuffleQs) quizData = shuffleArray(quizData);

// C·∫≠p nh·∫≠t parsed th√†nh m·∫£ng ƒë√£ tr·ªôn ƒë·ªÉ render s·ª≠ d·ª•ng

parsed = quizData;

currentIndex = 0;

userAnswers = {};

document.querySelector('.right-col').style.display = 'block';

document.body.classList.add('fullscreen-quiz');

renderQuestion(currentIndex);

});

// Render question
function renderQuestion(i) {
    if (!parsed[i]) {
        preview.innerHTML = '<div style="color:var(--muted)">H·∫øt c√¢u. Nh·∫•n "L√†m l·∫°i" ƒë·ªÉ l√†m l·∫°i.</div>';
        return;
    }

    const p = parsed[i];
    quizStatus.textContent = `${i + 1}/${parsed.length}`;

    // Hi·ªÉn th·ªã th√¥ng b√°o cho c√¢u h·ªèi nhi·ªÅu ƒë√°p √°n
    const multipleNotice = p.multiple ? '<div style="color:#f59e0b; font-size:14px; margin-bottom:8px;">üìå C√¢u h·ªèi c√≥ nhi·ªÅu ƒë√°p √°n ƒë√∫ng</div>' : '';

    const choicesHtml = p.choices
        .map(
            (c) => `
            <div class="choice" data-key="${c.key}">
                <strong>${c.key.toUpperCase()}.</strong> ${c.text}
            </div>`
        )
        .join('');

    preview.innerHTML = `
        <div class="question-card">
            <div><strong>C√¢u ${i + 1}:</strong> ${p.question}</div>
            ${multipleNotice}
            <div class="choices">${choicesHtml}</div>
        </div>`;

    document.querySelectorAll('.choice').forEach((ch) => {
        ch.addEventListener('click', () => handleChoiceSelect(ch));
    });
}

// Handle answer

function handleChoiceSelect(chEl) {
    if (isProcessing) return;

    isProcessing = true;
    const key = chEl.dataset.key;
    const idx = currentIndex;
    const question = parsed[idx];
    const correctAnswers = question.correct || [];
    const isMultiple = question.multiple;

    // Kh·ªüi t·∫°o m·∫£ng l∆∞u c√¢u tr·∫£ l·ªùi c·ªßa user n·∫øu ch∆∞a c√≥
    if (!userAnswers[idx + 'selected']) {
        userAnswers[idx + 'selected'] = [];
    }

    const selectedAnswers = userAnswers[idx + 'selected'];

    if (isMultiple) {
        // C√¢u h·ªèi nhi·ªÅu ƒë√°p √°n - toggle l·ª±a ch·ªçn
        if (selectedAnswers.includes(key)) {
            // B·ªè ch·ªçn n·∫øu ƒë√£ ch·ªçn r·ªìi
            const index = selectedAnswers.indexOf(key);
            selectedAnswers.splice(index, 1);
            chEl.classList.remove('selected');
        } else {
            // Th√™m v√†o danh s√°ch ch·ªçn
            selectedAnswers.push(key);
            chEl.classList.add('selected');
        }

        // Ki·ªÉm tra xem ƒë√£ ch·ªçn ƒë·ªß s·ªë ƒë√°p √°n ch∆∞a
        const allCorrectSelected = correctAnswers.every(ca => selectedAnswers.includes(ca));
        const noExtraSelected = selectedAnswers.every(sa => correctAnswers.includes(sa));
        const isFullyCorrect = allCorrectSelected && noExtraSelected && selectedAnswers.length === correctAnswers.length;

        // Hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng n·∫øu ƒë√£ ch·ªçn ƒë·ªß
        if (selectedAnswers.length === correctAnswers.length) {
            document.querySelectorAll('.choice').forEach((c) => {
                const choiceKey = c.dataset.key;
                if (correctAnswers.includes(choiceKey)) {
                    c.classList.add('correct');
                }
                if (selectedAnswers.includes(choiceKey) && !correctAnswers.includes(choiceKey)) {
                    c.classList.add('wrong');
                }
            });

            userAnswers[idx] = isFullyCorrect;

            setTimeout(() => {
                isProcessing = false;
                currentIndex++;
                if (currentIndex < parsed.length) renderQuestion(currentIndex);
                else showSummary();
            }, autoAdvanceMs);
        } else {
            isProcessing = false;
        }
    } else {
        // C√¢u h·ªèi m·ªôt ƒë√°p √°n - gi·ªØ nguy√™n logic c≈©
        userAnswers[idx + 'selected'] = [key];
        document.querySelectorAll('.choice').forEach((c) => c.classList.remove('correct', 'wrong', 'selected'));

        if (correctAnswers.includes(key)) {
            chEl.classList.add('correct');
            userAnswers[idx] = true;
        } else {
            chEl.classList.add('wrong');
            userAnswers[idx] = false;
            correctAnswers.forEach(correctKey => {
                const correctEl = Array.from(document.querySelectorAll('.choice')).find(
                    (c) => c.dataset.key === correctKey
                );
                if (correctEl) correctEl.classList.add('correct');
            });
        }

        setTimeout(() => {
            isProcessing = false;
            currentIndex++;
            if (currentIndex < parsed.length) renderQuestion(currentIndex);
            else showSummary();
        }, autoAdvanceMs);
    }
}

// Summary

function showSummary() {

const total = parsed.length;
    const correctList = [];
    const wrongList = [];

    parsed.forEach((q, i) => {
        const isCorrect = userAnswers[i];
        const questionHtml = q.question.replace(/<br\s*\/?>/gi, '<br>');
        const userSelected = userAnswers[i + 'selected'] || [];
        const correctAnswers = q.correct || [];

        if (isCorrect) {
            correctList.push(
                `<div class="result-item correct"><strong>C√¢u ${i + 1}:</strong> ${questionHtml}</div>`
            );
        } else {
            const userKeys = Array.isArray(userSelected) ? userSelected.join(', ').toUpperCase() : userSelected;
            const correctKeys = correctAnswers.join(', ').toUpperCase();
            
            wrongList.push(`
                <div class="result-item wrong">
                    <strong>C√¢u ${i + 1}:</strong> ${questionHtml}<br>
                    <b>Ch·ªçn:</b> ${userKeys}<br>
                    <b>ƒê√∫ng:</b> ${correctKeys}
                </div>`);
        }
    });

  preview.innerHTML = `
    <div class="result-summary">
        <h3>K·∫øt qu·∫£ l√†m b√†i</h3>
        <div class="result-stats">
            <span class="correct-count">ƒê√∫ng: ${correctList.length}</span>
            <span class="wrong-count">Sai: ${wrongList.length}</span>
            <span>T·ªïng: ${total}</span>
        </div>
        <div class="result-lists">
            <div class="result-list">
                <h4>‚úÖ C√¢u ƒë√∫ng (${correctList.length})</h4>
                ${correctList.join('')}
            </div>
            <div class="result-list">
                <h4>‚ùå C√¢u sai (${wrongList.length})</h4>
                ${wrongList.join('')}
            </div>
        </div>
        <div class="result-actions">
            <button id="retryBtn">L√†m l·∫°i</button>
            <button id="exitBtn" class="ghost">Quay l·∫°i trang ch·ªß</button>
        </div>
    </div>`;

document.getElementById('retryBtn').addEventListener('click', () => {
        currentIndex = 0;
        userAnswers = {};
        renderQuestion(0);
    });


document.getElementById('exitBtn').addEventListener('click', () => {
        document.body.classList.remove('fullscreen-quiz');
        document.querySelector('.right-col').style.display = 'none';
        preview.innerHTML = `<div style="color:var(--muted);font-size:13px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;
    });

}

const style = document.createElement('style');
style.textContent = `
    .choice.selected {
        background-color: rgba(15, 98, 254, 0.1);
        border-color: var(--accent);
    }
`;
document.head.appendChild(style);

window.addEventListener('load', () => {

const params = new URLSearchParams(window.location.search);

const quizParam = params.get('quiz');

if (quizParam) {

try {

parsed = JSON.parse(decodeURIComponent(quizParam));

document.querySelector('.right-col').style.display = 'block';

document.body.classList.add('fullscreen-quiz');

currentIndex = 0;

userAnswers = {};

renderQuestion(currentIndex);

} catch (e) {

console.error('Invalid quiz data', e);

}

}

});

</script>

</body>

</html>
